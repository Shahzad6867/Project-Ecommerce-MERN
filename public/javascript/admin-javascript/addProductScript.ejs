<script>
    feather.replace();
    let fileList = {}
    // Variant template
    const variantTemplate = (index) => `
        <div class="variant-item" data-index="${index}">
            <span class="remove-variant" onclick="removeVariant(this)"><i data-feather="x"></i></span>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
                    <input type="text" name="variants[${index}][size]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                    <input type="text" name="variants[${index}][color]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                    <input type="number" step="0.01" name="variants[${index}][price]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
                    <input type="number" name="variants[${index}][stockQuantity]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stock Status</label>
                    <select name="variants[${index}][stockStatus]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" >
                         <option value="">Select Stock Status</option>
                        <option value="In Stock">In Stock</option>
                        <option value="Out of Stock">Out of Stock</option>
                        <option value="Pre Order">Pre-Order</option>
                    </select>
                </div>
                <div class="lg:col-span-4">
                   <div class="flex justify-start align-items-center">
                     <label for="productImages${index}" class=" addBtn-primary bg-white py-3 px-3 rounded-md shadow-sm text-xl leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 cursor-pointer">Upload Images</label>
                     <span class="ml-2 text-lg font-medium "><strong>(Minimum 3 and Maximum 10 Images)</strong></span>
                    <input id="productImages${index}" type="file" name="variants[${index}][productImages]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 hidden" multiple accept="image/*"  onchange="previewImages(this, ${index})">
                    </div>
                    <div id="imagePreview-${index}" class="flex  flex-wrap gap-2 mt-2"></div>
                </div>
            </div>
        </div>
    `;

    // Add variant
    let variantCount = 0;
    document.getElementById('addVariantBtn').addEventListener('click', function() {
        document.getElementById('variantsContainer').insertAdjacentHTML('beforeend', variantTemplate(variantCount));
        feather.replace();
        variantCount++;
    });

    // Remove variant
    function removeVariant(el) {
        el.closest('.variant-item').remove();
    }
    // Image preview function
   
   
    function previewImages(input, index) {
        const previewContainer = document.getElementById(`imagePreview-${index}`);
        previewContainer.innerHTML = '';
        
        if (input.files.length < 3) {
            iziToast.warning({
                title: 'Warning',
                message: 'Please select at least 3 images',
                position: 'topCenter'
            });
            input.value = '';
            return;
        }
        if (input.files.length > 10) {
            iziToast.warning({
                title: 'Warning',
                message: 'You can upload a maximum of 10 images',
                position: 'topCenter'
            });
            input.value = '';
            return;
        }
        
        fileList[index] = new DataTransfer()

        for (let i = 0; i < input.files.length; i++) {
            fileList[index].items.add(input.files[i])
            console.log(fileList)
        }

        input.files = fileList[index].files
       
        let count = 0
        for (let i = 0; i < input.files.length; i++) {
            const reader = new FileReader();
            const file = input.files[i]
            reader.onload = function(e) {
                
                const imgBox = document.createElement('div');
                imgBox.className = 'inline-block min-w-[25%] max-w-[25%] min-h-[25%] max-h-[25%]   border rounded-md overflow-auto relative';
                imgBox.id = `imgCount${count}`
                count++
                imgBox.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-full object-cover" alt="Preview"> `;
                previewContainer.appendChild(imgBox);

                let cropperModal = document.getElementById("cropperModal")
                let cropperModalImg = document.getElementById("cropperImagePreview")
                let cropBtn = document.getElementById("crop-btn")
                let cancelBtn = document.getElementById("cancel-btn")
                let closeXBtn = document.getElementById("close-x-btn")
                imgBox.addEventListener("click",() => {
                    cropperModal.classList.remove("hidden")
                    cropperModalImg.src  = `${e.target.result}`

                    let cropper = new Cropper(cropperModalImg,{
                        aspectRatio : 1,
                        viewMode : 1,
                        guides : true,
                        background : true,
                        autoCropArea : 1,
                        zoomable : true
                    })
                    cancelBtn.addEventListener("click", () => {
                    cropper.destroy()
                    cropperModal.classList.add("hidden")
                     })
                    closeXBtn.addEventListener("click",() => {
                        cropper.destroy()
                        cropperModal.classList.add("hidden")
                    })
                    cropBtn.addEventListener("click", async () => {

                        let croppedCanvas = cropper.getCroppedCanvas()
                        if(croppedCanvas){
                           const fileName = file.name
                           const blob = await new Promise(res => croppedCanvas.toBlob(res,"image/jpeg"))
                           const croppedFile = new File([blob],fileName,{type : "image/jpeg"})
                           
                           const newList = new DataTransfer()
                           for(let j = 0 ; j < fileList[index].files.length ; j++){
                            const existingFile = fileList[index].files[j]

                            if(existingFile.name === fileName){
                                newList.items.add(croppedFile)
                            }else{
                                newList.items.add(existingFile)
                            }

                            
                           }
                           fileList[index] = newList
                            input.files = newList.files
                            imgBox.querySelector("img").src =  croppedCanvas.toDataURL("image/png")
                        }

                        cropper.destroy()
                        cropperModal.classList.add("hidden")
                    })
                })


               


            };
            reader.readAsDataURL(input.files[i]);
            
        }

        let cropInfo = document.createElement("span")
        cropInfo.style.paddingTop = "6rem"
        cropInfo.innerHTML =  "Click on image to Crop,<br><strong>Re-upload</strong> images<br>to update or remove any."
        previewContainer.appendChild(cropInfo)
        
        
    }
    
    // Form submission
    const productArrayString = '<%- JSON.stringify(products.map((product) => product.productName.toUpperCase().trim(),[])) %>';
     let productNames =  JSON.parse(productArrayString)
    function validateForm(){
        const productName = document.getElementById("productName")
        const category = document.getElementById("category")
        const brand = document.getElementById("brand")
        const description = document.getElementById("description")
        document.getElementsByName(`variants[${variantCount}]`)
        if(!productName.value){
            iziToast.error({
                title : "Error",
                message : "Please provide a name for the product",
                position : "topRight"
            })
            return false
        }else{
            if(productNames.some(name => name === productName.value.toUpperCase())){
                iziToast.error({
                    title : "Error",
                    message : "Product already exists",
                    position : "topRight"
                })
                return false
            }
        }

        if(!category.value){
            iziToast.error({
                title : "Error",
                message : "Select a category",
                position : "topRight"
            })
            return false
        }
        if(!brand.value){
            iziToast.error({
                title : "Error",
                message : "Select a brand",
                position : "topRight"
            })
            return false
        }

        if(!description.value){
            iziToast.error({
                title : "Error",
                message : "Provide a description",
                position : "topRight"
            })
            return false
        }

        const variantItems = document.querySelectorAll(".variant-item")
        if(variantItems.length === 0){
            iziToast.error({
                title : "Error",
                message : "Please add at least one variant",
                position : "topRight"
            })

            return false
        }
        
        let allVariantsValid = true;
        variantItems.forEach((variantItem) => {

            const index = variantItem.getAttribute("data-index")

            if(!validateVariant(index)){
                allVariantsValid = false
            }
        })

        if(!allVariantsValid){
            return false
        }

        return true
    }

    // Variant Validation
    function validateVariant(index) {
        const size = document.querySelector(`[name="variants[${index}][size]"]`);
        const color = document.querySelector(`[name="variants[${index}][color]"]`);
        const price = document.querySelector(`[name="variants[${index}][price]"]`);
        const stockQuantity = document.querySelector(`[name="variants[${index}][stockQuantity]"]`);
        const stockStatus = document.querySelector(`[name="variants[${index}][stockStatus]"]`);
        const productImages = document.querySelector(`[name="variants[${index}][productImages]"]`);

        if (!size.value) {
            iziToast.error({
                title: "Error",
                message: `Variant ${parseInt(index) + 1}: Please provide a size.`,
                position: "topRight"
            });
            return false;
        }
        if (!color.value) {
            iziToast.error({
                title: "Error",
                message: `Variant ${parseInt(index) + 1}: Please provide a color.`,
                position: "topRight"
            });
            return false;
        }
        if (price.value) {
            if(price.value <= 0){
                    iziToast.error({
                    title: "Error",
                    message: `Variant ${parseInt(index) + 1}: Please provide a valid price above 0`,
                    position: "topRight"
                });
                return false;
            }
        }else{
            iziToast.error({
                    title: "Error",
                    message: `Variant ${parseInt(index) + 1}: Please provide a price`,
                    position: "topRight"
                });
                return false;
        }
        if (stockQuantity.value ) {
            if(stockQuantity.value < 0){
                iziToast.error({
                title: "Error",
                message: `Variant ${parseInt(index) + 1}: Please provide a valid stock quantity from 0 and above`,
                position: "topRight"
                });
                return false;
            }
        }else{
            iziToast.error({
                title: "Error",
                message: `Variant ${parseInt(index) + 1}: Please provide a stock quantity`,
                position: "topRight"
                });
                return false;
        }

        if (!stockStatus.value ) {
            iziToast.error({
            title: "Error",
            message: `Variant ${parseInt(index) + 1}: Please select a stock status`,
            position: "topRight"
            });
            return false;
        }
        
        if(productImages.files.length < 3){
            iziToast.error({
            title: "Error",
            message: `Variant ${parseInt(index) + 1}: Please select at least 3 Images for the Product`,
            position: "topRight"
            });
            return false;
        }

        return true
        
    }



    // Add initial variant
    document.getElementById('addVariantBtn').click();        
</script>

</body>
</html>