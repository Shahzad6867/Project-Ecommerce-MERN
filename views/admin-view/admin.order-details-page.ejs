<%- include("../partials/admin-side/admin-universal-header.ejs",{title : "Admin - Order Detail Page"}) %>
<%- include("../partials/admin-side/navbar.ejs") %>
   <div class="relative">
    <div id="updationOverlay" class="absolute w-full h-full opacity-50 z-[99] px-[35rem] py-[20rem] bg-black hidden">
        <h1 class="text-white text-5xl ">Updating ...</h1>
    </div>
        <div class="w-full p-10 mt-5 ">
            <input type="text" id="serverMessage" value="<%= message ? message : ' ' %>" hidden>
            <div class="flex justify-between items-center mb-8 ">
                <div>
                    <h1 class="text-3xl font-bold">Order Details</h1>
                    <p class="text-gray-600">Order <%= order.orderId %> â€¢ Placed on <%= new Date(order.createdAt).toLocaleDateString("en-IN", {
                                    day: "numeric",
                                    month: "short",
                                    year: "numeric"
                                })%></p>
                </div>
                <div class="flex">
                    <a href="/admin/orders">
                        <button type="button" class="px-2 py-2 bg-green-400  text-black rounded-md hover:bg-green-300 flex items-center" >
                            <i data-feather="arrow-left" class="w-4 h-4 mr-1"></i>Back to Orders
                        </button> 
                    </a>
                </div>
                
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                
                <div class="lg:col-span-2">
                    <div class="order-card p-6 mb-6 border">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold ">Order Summary</h2>
                            <div class="flex items-center">
                            
                                <span class="px-3 py-1 rounded-full text-sm font-bold
                                <%= order.status[order.status.length - 1] === 'Pending' ? 'bg-gray-100 text-gray-700' :
                            order.status[order.status.length - 1] === 'Processed' ? 'bg-yellow-100 text-yellow-700' : 
                            order.status[order.status.length - 1] === 'Shipped' ? 'bg-blue-100 text-blue-700' : 
                                order.status[order.status.length - 1] === 'Delivered' ? 'bg-green-100 text-green-700' : 
                            order.status[order.status.length - 1] === 'Cancelled' ? 'bg-red-100 text-red-700' :
                            'bg-gray-100 text-gray-700' %>">
                                <%= order.status[order.status.length - 1] %>
                            </span>
                            
                            </div>
                            
                        </div>

                    
                        <div class="divide-y divide-gray-200">
                            <% for( let i = 0; i < order.items.length; i++ ) { %>
                                <div class="py-4 flex items-center">
                                    <% if (!order.items[i].isCancelled && !order.isCancelled) { %>
                                        <img src="<%= order.items[i].productImage %>" class="product-image border rounded" alt="Product">
                                        <div class="py-4 flex flex-wrap items-center w-[50%]">
                                        
                                            <div class="ml-4 flex-1 ">
                                                <h4 class="font-medium"><%= order.items[i].productName %></h4>
                                                <p class="text-sm text-black">Color: <%= order.items[i].color %></p>
                                                <p class="text-sm text-black">Size: <%= order.items[i].size %></p>
                                                <p class="text-sm text-black mt-1">Qty: <%= order.items[i].quantity %></p>
                                                <p class="font-medium text-black">Price : $<%= order.items[i].price %></p>
                                            </div>
                                            
                                        </div>
                                    <% } else {%>
                                        <img src="<%= order.items[i].productImage %>" class="product-image border rounded opacity-50" alt="Product">
                                        <div class="py-4 flex flex-wrap items-center w-[50%]">
                                        
                                            <div class="ml-4 flex-1 ">
                                                <h4 class="font-medium text-gray-400"><%= order.items[i].productName %></h4>
                                                <p class="text-sm text-gray-400">Color: <%= order.items[i].color %></p>
                                                <p class="text-sm text-gray-400">Size: <%= order.items[i].size %></p>
                                                <p class="text-sm text-gray-400 mt-1">Qty: <%= order.items[i].quantity %></p>
                                                <p class="font-medium text-gray-400">Price : $<%= order.items[i].price %></p>
                                            </div>
                                        
                                        </div>
                                    <% } %>
                                    <% if(order.isCancelled || order.items[i].isCancelled) {%>
                                        <div class="flex justify-end w-[50%] items-center ">
                                            <button type="button" class="bg-red-100 text-red-500 p-2 font-bold rounded-xl" disabled>Cancelled</button>
                                        </div>
                                    <% } %>    
                                </div>
                            <% } %>
                            
                            <!-- More items would go here -->
                        </div>
                        <div class="border-t border-gray-200 pt-4">
                            <div class="flex justify-end">
                                <div class="w-full ">
                                    <div class="flex justify-between py-2">
                                        <% let sumOfQuantity = 0 %>
                                        <% for( let i = 0; i < order.items.length; i++ ) { %>
                                            <% if (!order.items[i].isCancelled) { %>
                                                <% sumOfQuantity += order.items[i].quantity %>
                                            <% } %>
                                            
                                        <% } %>
                                        <span class="text-gray-600">Subtotal (<%= sumOfQuantity %> items)</span>
                                        <span class="font-medium">$<%= order.subTotal %></span>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <span class="text-gray-600">Shipping</span>
                                        <span class="font-medium">Free</span>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <span class="text-gray-600">Tax</span>
                                        <span class="font-medium">$<%= order.tax %></span>
                                    </div>
                                    <div class="flex justify-between py-2 font-bold text-lg border-t border-gray-200 mt-2">
                                        <span>Total</span>
                                        <span>$<%= order.grandTotal %></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                
                    
                    
                </div>

                <div class="space-y-6 ">
                
                    <div class="order-card p-6 mb-6 border">
                        <h2 class="text-xl font-bold mb-4">Update Order Status</h2>
                        <div class="flex justify-between">
                            <select id="orderUpdateStatus" name="status" class="w-[50%] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" >
                                <% if (order.status[order.status.length - 1] === "Delivered" || order.status[order.status.length - 1] === "Cancelled") { %>
                                    <option name="" value="" id="" selected disabled><%= order.status[order.status.length - 1] %></option>
                                <% } else { %>
                                    <option name="" value="" id="" selected ><%= order.status[order.status.length - 1] %></option>
                                    <% } %>
                                
                                <% if (order.status[order.status.length - 1] === "Pending") { %>
                                    <option value="Processed" >Processed</option>
                                <% } else if(order.status[order.status.length - 1] === "Processed"){ %>
                                    <option value="Shipped" >Shipped</option>
                                <% } else if(order.status[order.status.length - 1] === "Shipped"){ %>
                                    <option value="Out for Delivery" >Out for Delivery</option>
                                <% } else if(order.status[order.status.length - 1] === "Out for Delivery"){ %>
                                        <option value="Delivered" >Delivered</option>
                                <% } %>
                            </select>
                            
                            <button type="button" id="updateStatusBtn" class="px-4 py-2 btn-primary text-gray-700 rounded-md hover:bg-gray-100 flex items-center" onclick="updateStatus('<%- order._id %>')">
                                Update Status
                            </button>
                        </div>
                    </div>
                    <div class="order-card p-6 border">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i data-feather="user" class="mr-2"></i> User Information
                        </h3>
                        <div class="space-y-2 text-gray-700">
                            <p><strong>Name :</strong> <%= order.userId.firstName %> <%= order.userId.lastName %></p>
                            <p><strong>Phone No:</strong> <%= (order.userId.phone !== null ) ? order.userId.phone : "Not Provided" %></p>
                            <p><strong>Email :</strong> <%= order.userId.email%></p>
                        </div>
                    </div>
                    
                    
                    <div class="order-card p-6 border">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i data-feather="truck" class="mr-2"></i> Shipping Information
                        </h3>
                        <div class="space-y-2 text-gray-700">
                            <p><%= order.addressId.firstName %> <%= order.addressId.lastName %></p>
                            <p><%= order.addressId.address %></p>
                            <p><%= order.addressId.state %>, <%= order.addressId.pincode %></p>
                            <p><%= order.addressId.country %></p>
                            <p ><strong>Phone:</strong> <%= order.addressId.mobileNo %></p>
                            <p><strong>Shipping Method:</strong> Standard Shipping (Free)</p>
                        </div>
                    </div>
                    <div class="order-card p-6 border">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i data-feather="credit-card" class="mr-2"></i> Payment Information
                        </h3>
                        <div class="space-y-2 text-gray-700">
                            <p><strong>Payment Method:</strong> <%= order.paymentId.paymentMethod %></p>
                            <p><strong>Payment Status:</strong> <%= order.paymentId.status %></p>
                            <% if(order.paymentId.paymentDate === null){ %>
                                <p><strong>Payment Date:</strong> Not Paid Yet</p>
                            <% }else{ %>
                                <p><strong>Payment Date:</strong> <%= new Date(order.paymentId.paymentDate ).toLocaleDateString("en-IN", {
                                    day: "numeric",
                                    month: "short",
                                    year: "numeric"
                                })%></p>
                            <% } %>
                            <p><strong>Total Amount to be Paid:</strong> $<%= order.paymentId.amountToBePaid %></p>
                            <p><strong>Total Paid:</strong> $<%= order.paymentId.amountPaid %></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
            
            
            
        </div>
     
   </div>
    
   

    <script>
        feather.replace();
        function cancelItem(orderId,itemId){
            iziToast.question({
        theme : "light",
        title : "Delete Address",
        message : "Are you sure you want to cancel this item ?",
        position : "topCenter",
        overlay : true,
        close : false,
        id : "cancelItem",
        zindex : 9999,
        timeout : 30000,
        backgroundColor : "white", 
        buttons : [
            ["<button>OK</button>",function(instance,toast){
                instance.hide({transitionOut : "fadeOut"},toast,'button')

                fetch(`/orders/${orderId}/cancel-item?item=${itemId}`,{method : "PATCH"})
                .then(res => window.location.href = `/orders/${orderId}` )
                .catch(error => iziToast.error({
                    title : error.name ,
                    message : error.message,
                    position : "topRight"
                }))

            }],
            ["<button>Cancel</button>",function(instance,toast){
                instance.hide({transitionOut : "fadeOut"},toast,'button')
                console.log("Deletion Cancelled")
            }]
        ]
    })
        }

        let serverMessage = document.getElementById("serverMessage").value
        if(serverMessage === "Status Updated Successfully"){
            iziToast.success({
                title : "Success",
                message : serverMessage,
                position : "topRight"
            })
        }

        function reorder(cartId){
            
                    fetch(`/cart/reorder?orderId=${cartId}`,{method : "POST"})
                .then(res => window.location.href = "/cart")
                .catch(error => {
                    iziToast({
                        title : "Error",
                        message : error.message,
                        position : "topRight"
                    })
                    
                })
                
        }
        function updateStatus(orderId){
            
          let statusToBe = document.getElementById("orderUpdateStatus").value
          if(statusToBe !== "" && statusToBe === "Processed"){
            document.getElementById("updateStatusBtn").disabled = true
            document.getElementById("updationOverlay").classList.remove("hidden")
            fetch(`/admin/orders/${orderId}/update-status?status=${statusToBe}`,{method : "PATCH"})
            .then(res => window.location.href = `/admin/orders/${orderId}`)
          }else if(statusToBe !== "" && statusToBe === "Shipped"){
            document.getElementById("updateStatusBtn").disabled = true
            document.getElementById("updationOverlay").classList.remove("hidden")
            fetch(`/admin/orders/${orderId}/update-status?status=${statusToBe}`,{method : "PATCH"})
            .then(res => window.location.href = `/admin/orders/${orderId}`)
            .catch(error => {
                console.log(error)
            })
          }else if(statusToBe !== "" && statusToBe === "Out for Delivery"){
            document.getElementById("updateStatusBtn").disabled = true
            document.getElementById("updationOverlay").classList.remove("hidden")
            fetch(`/admin/orders/${orderId}/update-status?status=${statusToBe}`,{method : "PATCH"})
            .then(res => window.location.href =`/admin/orders/${orderId}`)
          }else if(statusToBe !== "" && statusToBe === "Delivered"){
            document.getElementById("updateStatusBtn").disabled = true
            document.getElementById("updationOverlay").classList.remove("hidden")
            fetch(`/admin/orders/${orderId}/update-status?status=${statusToBe}`,{method : "PATCH"})
            .then(res => window.location.href = `/admin/orders/${orderId}`)
          }
        }
    </script>
</body>
</html>