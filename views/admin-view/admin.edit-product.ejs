<%- include("../partials/admin-side/admin-universal-header.ejs",{title : "Admin - User Management"}) %>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo text-gray-600">NovaMart</div>
        <div class="user-icon">
            <span class="iconify" data-icon="qlementine-icons:user-16" style="width: 32;height: 32;color: #474744;"></span>
        </div>
    </nav>

    

    <!-- Main Content -->
    <div class="main-content-for-addProduct">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Edit Product</h1>
            <div class="flex space-x-4">
                <a href="/admin/products" class="px-4 py-2 addBtn-primary rounded-md text-sm font-medium text-gray-700 ">
                    <i data-feather="arrow-left" class="mr-2"></i>
                    Back to Products
                </a>
            </div>
        </div>

        <form id="productForm" action="/admin/edit-product?id=<%= product[0]._id %>" method="post" enctype="multipart/form-data"  class="bg-white rounded-lg shadow p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" name="productName" value="<%= product[0].productName %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select name="categoryId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" >
                        <option value="<%= product[0].categoryId._id %>"><%= product[0].categoryId.categoryName%> (Saved at)</option>
                        <% for( let i = 0; i < categories.length; i++ ) { %>
                            <option value="<%= categories[i]._id  %>"><%= categories[i].categoryName %></option>
                        <% } %>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                    <select name="brandId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="<%= product[0].brandId._id %>"><%= product[0].brandId.brandName %> (Saved at)</option>
                        <% for( let i = 0; i < brands.length; i++ ) { %>
                            <option value="<%= brands[i]._id %>"><%= brands[i].brandName %></option>
                        <% } %>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" rows="3"><%= product[0].description %></textarea>
                </div>
            </div>

            <div class="mt-8">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Product Variants</h3>
                <div id="variantsContainer">
                    <input type="hidden" id="variantCountInput" value="<%= product[0].variants.length - 1 %>">
                    <!-- Variants will be added here -->
                </div>
                <button type="button" id="addVariantBtn" class="mt-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                    <i data-feather="plus" class="mr-2"></i>Add Variant
                </button>
            </div>

            <div class="mt-8 flex justify-end space-x-3">
                <button type="reset" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Reset
                </button>
                <button type="submit" class="px-4 py-2  rounded-md shadow-sm text-sm font-semibold text-gray-700 btn-primary  focus:outline-none focus:ring-2 focus:ring-offset-2 ">
                    Save Product
                </button>
            </div>
        </form>
    </div>





    <script>
        feather.replace();
        
        // Variant template
        const variantTemplate = (index) => `
        
        <% for( let j = 0; j < product[0].variants.length; j++ ) { %>
    <div class="variant-item" data-index="${index}">
        <span class="remove-variant" onclick="removeVariant(this)"><i data-feather="x"></i></span>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
                <input type="text" name="variants[${index}][size]" value="<%= product[0].variants[j].size %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                <input type="text" name="variants[${index}][color]" value="<%= product[0].variants[j].color %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                <input type="number" step="0.01" name="variants[${index}][price]" value="<%= product[0].variants[j].price %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
                <input type="number" name="variants[${index}][stockQuantity]" value="<%= product[0].variants[j].stockQuantity %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Status</label>
                <select name="variants[${index}][stockStatus]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" >
                    <option value="<%= product[0].variants[j].stockStatus %>"><%= product[0].variants[j].stockStatus %> (Saved At)</option>
                    <option value="In-Stock">In Stock</option>
                    <option value="Out-of-Stock">Out of Stock</option>
                    <option value="Pre-Order">Pre-Order</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Images (Min 3 required and Max 20 Images)</label>
                <input type="file" name="variants[${index}][productImages]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" multiple accept="image/*"  onchange="previewImages(this, ${index})">
                <div id="imagePreview-${index}" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
</div>
    </div>
    <% } %>`;

        // Add variant
        let variantCount = 0;
        document.getElementById('addVariantBtn').addEventListener('click', function() {
            document.getElementById('variantsContainer').insertAdjacentHTML('beforeend', variantTemplate(variantCount));
            feather.replace();
            variantCount++;
        });

        // Remove variant
        function removeVariant(el) {
            el.closest('.variant-item').remove();
        }
        // Image preview function
        function previewImages(input, index) {
            const previewContainer = document.getElementById(`imagePreview-${index}`);
            previewContainer.innerHTML = '';
            
            if (input.files.length < 3) {
                iziToast.warning({
                    title: 'Warning',
                    message: 'Please select at least 3 images',
                    position: 'topCenter'
                });
                input.value = '';
                return;
            }

            for (let i = 0; i < input.files.length; i++) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgBox = document.createElement('div');
                    imgBox.className = 'w-24 h-24 border rounded-md overflow-hidden relative';
                    imgBox.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-full object-cover" alt="Preview">
                        <button type="button" onclick="removeImage(this, ${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                            Ã—
                        </button>
                    `;
                    previewContainer.appendChild(imgBox);
                };
                reader.readAsDataURL(input.files[i]);
            }
        }

        // Remove image function
        function removeImage(btn, index) {
            const previewContainer = document.getElementById(`imagePreview-${index}`);
            btn.parentElement.remove();
            
            const input = document.querySelector(`input[name="variants[${index}][productImages]"]`);
            if (previewContainer.children.length < 3) {
                input.setCustomValidity('At least 3 images ');
            } else {
                input.setCustomValidity('');
            }
        }

        // Form submission
            const form = document.getElementById("productForm");
            const input = document.getElementById("productImages");

            form.addEventListener("submit", function (e) {
            if (input.files.length < 3) {
                e.preventDefault(); // stop form submission
                alert("Please upload at least 3 images before submitting.");
            }
            })

        // Add initial variant
        document.getElementById('addVariantBtn').click();
    </script>
</body>
</html>