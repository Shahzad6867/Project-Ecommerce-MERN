<%- include("../partials/user-side/navbar.ejs")%>
<div class="flex">
<%- include("../partials/user-side/userProfile-sidebar.ejs",{dashboardBtn : "",profileBtn : "",ordersBtn : "",shoppingCartBtn : "",addressBtn : "active disabled",walletBtn : ""})%>
        <div class="main-content">
 
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">My Orders</h1>
                <div class="flex items-center">
                    <div class="relative mr-4">
                        <select class="border border-gray-300 rounded-md px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option>All Orders</option>
                            <option>Processing</option>
                            <option>Shipped</option>
                            <option>Delivered</option>
                            <option>Cancelled</option>
                        </select>
                        
                    </div>
                    <div class="relative">
                        <input type="text" placeholder="Search orders..." class="border border-gray-300 rounded-md px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <i data-feather="search" class="absolute left-3 top-2 text-gray-500"></i>
                    </div>
                </div>
            </div>
            <% if (orders.length > 0) { %>
                <div class="space-y-6">
                    <!-- Order 1 -->
                    <% orders.forEach(order => { %>
                        <div class="order-card p-6 border rounded-lg mb-6 bg-white shadow-sm">
                          <% if ((order.paymentId.status === "Pending" ||order.paymentId.status === "Payment Failed"  ) && order.paymentId.paymentMethod === "Pay with Stripe" && !order.status.includes("Cancelled")) { %>
                            <div class="flex items-center rounded-xl px-2 py-[0.2rem] bg-yellow-300 w-[80%] mb-3">
                             <i data-feather="alert-triangle" class="w-5 h-5 mr-1"></i>
                             <p class="text-sm text-black">
                               Please complete the payment by <span class="font-bold" ><%= new Date(order.willBeCancelledAt).toLocaleDateString("en-IN", {day: "numeric",month: "short",year: "numeric"
                             }) %>, </span><span class="font-bold"><%= new Date(order.willBeCancelledAt).toLocaleTimeString('en-US', {   hour: '2-digit',minute: '2-digit',  hour12: true }) %></span>
                               If payment is not received by then, this order will be automatically cancelled.
                              </p>
                            </div>
                           <% } %>
                          <!-- Top Section -->
                          <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                            <div>
                              <h2 class="text-lg font-semibold">
                                Order ID: <span class="text-gray-700"><%= order.orderId %></span>
                              </h2>
                              <% if (!order.isCancelled) { %>
                                <p class="text-sm text-gray-500">
                                  Placed on 
                                  <%= new Date(order.createdAt).toLocaleDateString("en-IN", {
                                      day: "numeric",
                                      month: "short",
                                      year: "numeric"
                                  }) %>
                                </p>
                              <% } else{ %>
                                <p class="text-sm text-gray-500">
                                  Cancelled on 
                                  <%= new Date(order.statusTimeline.cancelledAt).toLocaleDateString("en-IN", {
                                      day: "numeric",
                                      month: "short",
                                      year: "numeric"
                                  }) %>
                                </p>
                                <% } %>
                                
                              
                            </div>
                        
                            <div class="flex items-center mt-3 md:mt-0">
                              <p>Payment Status : </p>
                              <span class="px-3 py-1 ml-1 mr-4 rounded-full text-sm font-bold
                                <%= order.paymentId.status === 'Pending' ? 'bg-yellow-100 text-yellow-700' :
                                order.paymentId.status === 'Paid Successfully' ? 'bg-green-100 text-green-700' : 
                              order.paymentId.status === 'Payment Failed' ? 'bg-red-100 text-red-700' :
                              order.paymentId.status === 'Order Cancelled' ? 'bg-red-100 text-red-700' :
                               'bg-gray-100 text-gray-700' %>">
                                <%= order.paymentId.status %>
                              </span>
                              <p>Order Status : </p>
                              <span class="px-3 py-1 ml-1 rounded-full text-sm font-bold
                                <%= order.status[order.status.length - 1] === 'Pending' ? 'bg-gray-100 text-gray-700' :
                               order.status[order.status.length - 1] === 'Processed' ? 'bg-yellow-100 text-yellow-700' : 
                               order.status[order.status.length - 1] === 'Shipped' ? 'bg-blue-100 text-blue-700' : 
                                order.status[order.status.length - 1] === 'Delivered' ? 'bg-green-100 text-green-700' : 
                              order.status[order.status.length - 1] === 'Cancelled' ? 'bg-red-100 text-red-700' :
                              order.status[order.status.length - 1] === 'Return Order Requested' ? 'bg-yellow-400 text-black' :
                               'bg-gray-100 text-gray-700' %>">
                                <%= order.status[order.status.length - 1] %>
                              </span>
                        
                              <span class="mx-4 hidden md:block text-gray-300">|</span>
                        
                              <span class="text-lg font-semibold">
                                $<%= order.grandTotal %>
                              </span>
                            </div>
                          </div>
                        
                          <!-- Middle Section -->
                          <div class="border-t pt-4 flex flex-col md:flex-row md:justify-between">
                        
                            <div class="text-sm w-[50%] flex justify-between">
                              <div>
                                <p class="text-gray-500">Items</p>
                                <% let sumOfQuantity = 0 %>
                                <% for( let i = 0; i < order.items.length; i++ ) { %>
                                    <% if (!order.items[i].isCancelled) { %>
                                        <% sumOfQuantity += order.items[i].quantity %>
                                    <% } %>
                                     
                                <% } %>
                                <p class="font-medium"><%= sumOfQuantity %> item(s)</p>
                              </div>
                        
                              <div>
                                <p class="text-gray-500">Payment</p>
                                <% if (order.paymentId.paymentMethod === "Pay with Stripe" && (order.paymentId.status === "Pending"||order.paymentId.status === "Payment Failed" || order.paymentId.status === "Order Cancelled")) { %>
                                  <p class="font-medium">Pay with Credit / Debit Card</p>
                                <% } else if(order.paymentId.paymentMethod === "Pay with Stripe" && order.paymentId.status === "Paid Successfully"){%>
                                  <p class="font-medium">Paid with Credit / Debit Card</p>
                                <% } else if(order.paymentId.paymentMethod === "Pay with NovaWallet" && order.paymentId.status === "Pending") { %>
                                    <p class="font-medium">Pay with NovaWallet</p>
                                <% } else if(order.paymentId.paymentMethod === "Pay with NovaWallet" && order.paymentId.status === "Paid Successfully") { %>
                                  <p class="font-medium">Paid with NovaWallet</p>
                                  <% } else { %>
                                    <p class="font-medium"><%= order.paymentId.paymentMethod %></p>
                                   <% } %>
                                
                              </div>
                        
                              <div>
                                <p class="text-gray-500">Delivery</p>
                                <p class="font-medium">Standard</p>
                              </div>
                            </div>
                        
                            <!-- Action -->
                            <div class="mt-4 md:mt-0 flex gap-3">
                              <a href="/orders/<%= order._id %>"
                                class="px-4 py-2 border rounded-md hover:bg-gray-100 font-bold flex items-center">
                                <i data-feather="eye" class="w-4 h-4 mr-2"></i>
                                View Details
                              </a>

                        
                              <% if(order.status.includes("Shipped") && !order.status.includes("Return Order Requested")) { %>
                                <a href="<%= order.invoiceUrl %>"
                                  class="px-4 py-2 bg-blue-600 text-white flex items-center font-bold rounded-md hover:bg-blue-700" download>
                                  <i data-feather="download" class="w-4 h-4 mr-2"></i>
                                  Download Invoice
                                </a>
                                
                              <% } %>
                              <% if (!order.status.includes("Return Order Requested") && order.status.includes("Delivered")) { %>
                                <a href="/orders/<%= order._id %>/return-order"
                                    class="px-4 py-2 border btn-primary rounded-md font-bold flex items-center">
                                    <i data-feather="rotate-ccw" class="w-4 h-4 mr-2"></i>
                                    Return Order
                                  </a>
                              <% } %>

                              <% if ((order.paymentId.status === "Pending" || order.paymentId.status === "Payment Failed") & order.paymentId.paymentMethod === "Pay with Stripe" && !order.status.includes("Cancelled")) { %>
                                <a href="/orders/<%= order._id %>/pending-payment"
                                  class="px-4 py-2 bg-yellow-400 text-gray-700 hover:bg-yellow-300 rounded-md font-bold flex items-center">
                                  <i data-feather="credit-card" class="w-4 h-4 mr-2"></i>
                                  Complete Payment
                                </a>
                              <% } %>
                              
                            </div>
                        
                          </div>
                        </div>
                        <% }) %>
                        
                    
    
                    
                    </div>
                </div>
            <% } else { %>
                <div class="bg-white rounded-lg border shadow-sm w-full min-h-[40%]  p-6">
                    <div class="border-2 w-full h-[196px]  rounded-lg">
                        <h1 class="text-2xl font-bold ml-[20rem] mt-[3.8rem]">Looks like you havenâ€™t ordered anything yet !</h1>
                        <a href="/shop"><button type="button"  class="btn-primary ml-[32rem] flex font-bold rounded-full px-4 py-2 mt-1 "><i data-feather="shopping-cart" class="mr-2"></i>Shop Now</button></a>
                    </div>
                </div>
            <% } %>
       </div>
    </div>
    <%- include("../partials/user-side/footer.ejs")%>