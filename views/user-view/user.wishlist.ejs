
<%- include("../partials/user-side/navbar.ejs",{title : "Novamart - Home"})%>

    

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        


        <!-- Categories Grid -->
        


        <!-- Featured Products -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4">Wishlist</h2>
            <div id="itemsWishedDiv" class="flex flex-wrap">
                <!-- Product Card 1 -->
                 <% if (wishlistItems.length === 0) { %>
                  <div class="w-full h-[12rem] bg-white rounded-xl shadow-md p-6">
                    <div class="border-2 w-full h-full  rounded-lg">
                        <h1 class="text-2xl font-bold text-center mt-[2.5rem] ">Looks like you haven’t added anything yet !</h1>
                        <a href="/shop"><button type="button"  class="btn-primary ml-[33rem] flex font-bold rounded-full px-4 py-2 mt-1 "><i data-feather="shopping-cart" class="mr-2"></i>Shop Now</button></a>
                    </div>
                  </div>
                 <% } %>
                 <% const now = new Date() %>
                 <% for( let i = 0; i < wishlistItems.length; i++ ) { %>
                    <%

                    /* ================================
                    Base values
                    ================================ */
                    const price = wishlistItems[i].productId.variants[wishlistItems[i].variant].price
                    const quantity = wishlistItems[i].quantity

                    let offerPrice = price
                    let productOfferPrice = null
                    let categoryOfferPrice = null

                    /* ================================
                    Normalize offers (IMPORTANT)
                    Expired / upcoming => null
                    ================================ */
                    const productOffer =
                    wishlistItems[i].productOfferId &&
                    wishlistItems[i].productOfferId.startDate <= now &&
                    wishlistItems[i].productOfferId.endDate >= now
                        ? wishlistItems[i].productOfferId
                        : null

                    const categoryOffer =
                    wishlistItems[i].categoryOfferId &&
                    wishlistItems[i].categoryOfferId.startDate <= now &&
                    wishlistItems[i].categoryOfferId.endDate >= now
                        ? wishlistItems[i].categoryOfferId
                        : null

                    /* ================================
                    Product offer price
                    ================================ */
                    if (productOffer) {
                    if (productOffer.discountType === "percentage") {
                        productOfferPrice =
                        price - (price * productOffer.discountValue) / 100
                    } else if (productOffer.discountType === "flat") {
                        productOfferPrice =
                        price - productOffer.discountValue
                    }
                    }

                    /* ================================
                    Category offer price
                    ================================ */
                    if (categoryOffer) {
                    if (categoryOffer.discountType === "percentage") {
                        const percentPrice =
                        price - (price * categoryOffer.discountValue) / 100

                        const maxPrice =
                        price - categoryOffer.maxDiscountAmount

                        categoryOfferPrice = Math.max(percentPrice, maxPrice)

                    } else if (categoryOffer.discountType === "flat") {
                        if (price > categoryOffer.productMinPrice) {
                        categoryOfferPrice =
                            price - categoryOffer.discountValue
                        }
                    }
                    }

                    /* ================================
                    Decide final offer price
                    ================================ */
                    if (productOfferPrice !== null && categoryOfferPrice !== null) {
                    offerPrice = Math.min(productOfferPrice, categoryOfferPrice)

                    } else if (productOfferPrice !== null) {
                    offerPrice = productOfferPrice

                    } else if (categoryOfferPrice !== null) {
                    offerPrice = categoryOfferPrice
                    }

                    
                 %>

                            
                <div id="item<%= wishlistItems[i].productId._id %><%= wishlistItems[i].variant %>" class="product-card mr-2 mt-2 bg-white rounded-lg shadow-sm p-4 transition-all w-[240px] flex-shrink-0">
                    <div class="h-40 mb-3 relative">
                        <img src="<%= wishlistItems[i].productId.variants[wishlistItems[i].variant].productImages[0] %>" alt="Product" class="w-full h-full object-contain">
                        <button type="button" class="absolute top-2 right-2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100 hover:text-red-500" onclick="removeFromWishlist('<%- wishlistItems[i].productId._id %>','<%- wishlistItems[i].variant %>')">
                            <i data-feather="trash-2" class="w-4 h-4 "></i>
                        </button>
                        <a href="/product?id=<%= wishlistItems[i].productId._id %>&variant=<%= wishlistItems[i].variant %>">
                            <button class="absolute top-12 right-2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100">
                                <i data-feather="eye" class="w-4 h-4"></i>
                            </button>
                        </a>
                    </div>
                    <h3 class="font-medium text-sm mb-1 truncate"><%= wishlistItems[i].productId.productName  %></h3>
                    <div class="flex items-center mb-1">
                        <div class="text-yellow-400 flex">
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                        </div>
                        <span class="text-gray-500 text-xs ml-1">(4,567)</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="font-regular text-xs">Brand : <a href="#" class="text-blue-700"><%= wishlistItems[i].brandId.brandName %></a></span>
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="font-regular text-gray-700 text-xs">Size : <a href="#" ><%= (wishlistItems[i].productId.variants[wishlistItems[i].variant].size) %></a></span>
                    </div>
                    <div class="flex items-center mb-2">
                        <% if (offerPrice > 0 && offerPrice < wishlistItems[i].productId.variants[wishlistItems[i].variant].price ) { %>
                            <span class="font-bold text-lg">$ <span id="price<%= wishlistItems[i].productId._id %><%= wishlistItems[i].variant %>" ><%= offerPrice.toFixed(2) %></span></span>
                            <span class="text-gray-500 text-sm line-through ml-2">$<%= (wishlistItems[i].productId.variants[wishlistItems[i].variant].price).toFixed(2)  %></span>
                            <span class="text-green-600 text-xs font-medium ml-2"><%= (((wishlistItems[i].productId.variants[wishlistItems[i].variant].price - offerPrice) / wishlistItems[i].productId.variants[wishlistItems[i].variant].price) * 100).toFixed(0) %>% off</span>   
                        <% } else {%>
                            <span class="font-bold text-lg">$ <span id="price<%= wishlistItems[i].productId._id %><%= wishlistItems[i].variant %>" ><%= (wishlistItems[i].productId.variants[wishlistItems[i].variant].price).toFixed(2)  %></span></span>
                        <% } %>
                       
                    </div>
                            <button type="button" id="addedToCartBtn<%= wishlistItems[i].productId._id %><%= wishlistItems[i].variant %>" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-2 rounded-md font-bold text-sm flex items-center justify-center hidden" >
                                <i data-feather="check" class="w-4 h-4 mr-2"></i> Added to Cart
                            </button>
                            <button type="button" id="addToCartBtn<%= wishlistItems[i].productId._id %><%= wishlistItems[i].variant %>" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-2 rounded-md font-medium text-sm flex items-center justify-center" onclick="addToCartFromWishlist('<%- wishlistItems[i].productId._id  %>','<%- wishlistItems[i].variant %>')">
                                <i data-feather="shopping-cart" class="w-4 h-4 mr-2"></i> Add to Cart
                            </button>
                            
                      
                </div>     
                               <% } %> 
                           
                   
                <!-- More product cards... -->
            </div>
        </section>




      


        


        
    </main>

    <script>
         function deleteItemFromCart(cartId,productId,variantIndex) {
        let quantity = document.getElementById(`cartItemQty${productId}${variantIndex}`)
        let price = Number(document.getElementById(`price${cartId}${variantIndex}`).innerText)
        let addToCartBtn = document.getElementById(`addToCartBtn${productId}${variantIndex}`)
        let cartItemQtyToBeUpdated = document.getElementById(`cartItemQty${productId}${variantIndex}`)
        let myCartHead = document.getElementById("cartHeadItemCount")
        let cartItemQtyNotifier = document.getElementById("cartItemQty")
        let subTotal = document.getElementById("subTotal")
        let cartItem = document.getElementById(`cartItem${productId}${variantIndex}`)
        fetch(`/cart/delete-cart-item?cartItemId=${cartId}&productId=${productId}`,{method : "DELETE"})
                .then(res => res.json())
                .then(data => {
                   
                    
                myCartHead.innerText = Number(myCartHead.innerText) - Number(quantity.innerText)
                cartItemQtyNotifier.innerText = Number(cartItemQtyNotifier.innerText) - Number(quantity.innerText)
                subTotal.innerText = (Number(subTotal.innerText) -  (Number(quantity.innerText) * price) ).toFixed(2)
                cartItem.remove()
                if(document.getElementById("cartItemsDiv").children.length === 0){
                    document.getElementById("cartItemsDiv").innerHTML = `<div id="nothingInCartCard" class="flex  items-center justify-center border border-gray-400 w-[96%] text-left px-3 py-8 text-gray-700  rounded-lg m-2">
                                                                    <h1 class="font-bold">
                                                                        Your cart is empty. Start shopping!
                                                                    </h1>
                                                                </div>`
                }
                feather.replace()
                iziToast.info({
                    title: "Cart",
                    message: data.message,
                    position : "topRight"
                });
                })
    }
        function addToCartFromWishlist(productId,variant){
            fetch(`/cart?productId=${productId}&variant=${variant}&quantity=${1}`,{method : "POST"})
            .then(res => res.json())
            .then(data => {
                iziToast.success({
                    title : "Cart",
                    message : data.message,
                    position : "topRight"
                })
                
                document.getElementById(`addToCartBtn${productId}${variant}`).classList.add("hidden")
                document.getElementById(`addedToCartBtn${productId}${variant}`).classList.remove("hidden")
                let cartItemCount = document.getElementById("cartItemQty")
                let tempValue = Number(cartItemCount.innerText)
                tempValue++
                cartItemCount.innerText = tempValue
                let itemCount = document.getElementById("wishlistItemQty")
                if(Number(itemCount.innerText) > 0){
                    let value = Number(itemCount.innerText)
                    value--
                    itemCount.innerText = value
                    if(value === 0){
                        itemCount.classList.add("hidden")
                    }
                 }
            })
            .catch(error => {
                iziToast.error({
                    title : "Cart",
                    message : error.message,
                    position : "topRight"
                })
            })
        }
        function removeFromWishlist(productId,variant){
           
            fetch(`/wishlist/remove-wishlist-item?productId=${productId}&variant=${variant}`,{method : "DELETE"})
            .then(res => res.json())
            .then(data => {
                iziToast.success({
                    title : "Wishlist",
                    message : data.message,
                    position : "topRight"
                })
            })
            .catch(error => {
                iziToast.error({
                    title : "Wishlist",
                    message : error.message,
                    position : "topRight"
                })
            })
            document.getElementById(`item${productId}${variant}`).remove()
            let itemCount = document.getElementById("wishlistItemQty")
            if(Number(itemCount.innerText) > 0){
                let value = Number(itemCount.innerText)
                value--
                itemCount.innerText = value
                if(value === 0){
                    itemCount.classList.add("hidden")
                }
            }
            if(document.getElementById("itemsWishedDiv").children.length === 0){
                document.getElementById("itemsWishedDiv").innerHTML += `<div class="w-full h-[12rem] bg-white rounded-xl shadow-md p-6">
                    <div class="border-2 w-full h-full  rounded-lg">
                        <h1 class="text-2xl font-bold text-center mt-[2.5rem] ">Looks like you haven’t added anything yet !</h1>
                        <a href="/shop"><button type="button"  class="btn-primary ml-[33rem] flex font-bold rounded-full px-4 py-2 mt-1 "><i data-feather="shopping-cart" class="mr-2"></i>Shop Now</button></a>
                    </div>
                  </div>`
            }
        }
    </script>

    <!-- Footer -->
    <%- include("../partials/user-side/footer.ejs")%>

    
</body>
</html>
