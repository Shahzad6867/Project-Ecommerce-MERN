<%- include("../partials/user-side/navbar.ejs")%>

  <!-- Main Container -->
  <div class="flex max-w-7xl mx-auto my-10 px-4 gap-8">
    
    <!-- Sidebar Filters -->
    <aside class="w-1/4 bg-white p-5 rounded-xl shadow-sm">
      <h2 class="text-lg font-semibold mb-4">Filters</h2>

      <form action="/shop/filter" method="POST" class="space-y-6">

        <!-- Category Filter -->
        <div>
          <h3 class="font-medium mb-2">Category</h3>
          <div class="space-y-1">
            <% for( let i = 0; i < categories.length; i++ ) { %>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="category" value="<%= categories[i]._id  %>" class="accent-emerald-600">
              <%= categories[i].categoryName %>
            </label>
            <% } %>
          </div>
        </div>

        <!-- Price Filter -->
        <div>
          <h3 class="font-medium mb-2">Price Range</h3>
          <div class="flex items-center gap-2">
            <label for="minPrice">Min</label>
            <input type="number" id="minPrice" name="minPrice" placeholder="0" class="border rounded-lg w-1/2 p-2">
            <label for="minPrice">Max</label>
            <input type="number" id="maxPrice" name="maxPrice" placeholder="100" class="border rounded-lg w-1/2 p-2">
          </div>
        </div>

        <!-- Brand Filter -->
        <div>
          <h3 class="font-medium mb-2">Brand</h3>
          <div class="space-y-1">
            <% for( let i = 0; i < brands.length; i++ ) { %>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="brand" value="<%= brands[i]._id %>" class="accent-emerald-600">
                <%= brands[i].brandName %>
              </label>
            <% } %>
          </div>
        </div>

        <!-- Apply Filter Button -->
        <button type="submit" class="filterButton w-full font-bold text-gray-700 py-2 px-4 rounded-lg transition duration-300 mb-4">
          Apply Filters
        </button>
      </form>
    </aside>

    <!-- Product Section -->
    <section class="flex-1">

      <!-- Sort Buttons -->
      <div class="flex flex-wrap items-center justify-between mb-6">
        <h2 class="text-xl font-semibold">All Products</h2>
        <div class="flex gap-2">
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="featured">Featured</button>
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="low-high">Price: Low → High</button>
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="high-low">Price: High → Low</button>
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="az">A → Z</button>
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="za">Z → A</button>
        </div>
      </div>

      <!-- Products Grid -->
      <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <% for( let i = 0; i < products.length; i++ ) { %>
          <% if (!products[i].categoryId.isDeleted && !products[i].brandId.isDeleted) { %>
            <% if (!products[i].isDeleted) { %>
                <% for( let j = 0; j < products[i].variants.length; j++ ) { %>
                  <div class="product-card bg-white rounded-lg shadow-sm p-4 transition-all">
                    <div class="h-40 mb-3 relative">
                        <img src="<%= products[i].variants[j].productImages[0] %>" alt="Product" class="w-full h-full object-contain">
                        <button class="absolute top-2 right-2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100">
                            <i data-feather="heart" class="w-4 h-4"></i>
                        </button>
                        <a href="/product?id=<%= products[i]._id %>&variant=<%= j%>">
                            <button class="absolute top-12 right-2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100">
                                <i data-feather="eye" class="w-4 h-4"></i>
                            </button>
                        </a>
                    </div>
                    <h3 class="font-medium text-sm mb-1 truncate"><%= products[i].productName  %></h3>
                    <div class="flex items-center mb-1">
                        <div class="text-yellow-400 flex">
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                        </div>
                        <span class="text-gray-500 text-xs ml-1">(4,567)</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="font-regular text-xs">Brand : <a href="#" class="text-blue-700"><%= (products[i].brandId.brandName) %></a></span>
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="font-regular text-gray-700 text-xs">Size : <a href="#" ><%= (products[i].variants[j].size) %></a></span>
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="font-bold text-lg">$<%= (products[i].variants[j].price ).toFixed(2) %></span>
                      <!-- <span class="text-gray-500 text-sm line-through ml-2">$</span>
                        <span class="text-green-600 text-xs font-medium ml-2">38% off</span> -->
                    </div>
                     <% let isProductInCart = cartItems.find(item =>  String(products[i]._id) === String(item.productId._id) && item.variant === j ) || null %>
                        <% if (isProductInCart) { %>
                            <div class="flex  justify-between ">
                            <button type="button" id="addToCartBtn<%= products[i]._id %><%= j %>" class="w-[0%] bg-yellow-400 hover:bg-yellow-500 text-gray-900  rounded-md font-medium text-sm flex items-center justify-center" onclick="addToCartInitially(this,'<%- i %>','<%- j %>','<%- products[i]._id %>','<%- j %>')">
                                <i data-feather="shopping-cart" class="w-4 h-4 mr-2"></i> 
                            </button>
                                <div id="incDecQtyDiv<%= products[i]._id %><%= j %>" class="flex items-center justify-between w-[100%]  rounded-lg   border border-black w-full ">
                                    <button id="decQtyBtn<%= products[i]._id %><%= j %>" type="button" class="text-center flex justify-center w-full h-full bg-yellow-400 hover:bg-yellow-300 py-1 rounded-l-lg"  onclick="decrementQuantity('<%= i %>','<%= j %>','<%= products[i]._id %>')">
                                        <i data-feather="minus"></i>
                                    </button> 
                                    <input type="text" id="quantity<%= products[i]._id %><%= j %>" value="<%= isProductInCart.quantity %>" class=" w-[5rem] px-2 text-xl bg-white font-bold py-[0.22rem] border-black-x-sides text-center" >
                                    <button id="incQtyBtn<%= products[i]._id %><%= j %>" type="button" class="text-center flex justify-center w-full h-full py-1 bg-yellow-400 hover:bg-yellow-300 rounded-r-lg"  onclick="incrementQuantity('<%= i %>','<%= j %>','<%= products[i]._id %>')">
                                        <i data-feather="plus"></i>
                                    </button>
                                </div>
                            </div>
                    <% } else {%>
                        <!-- <a  href="/home/cart?productId=&variant=&quantity=1"> -->
                            <div id="incDecQtyDiv<%= products[i]._id %><%= j %>" class="flex items-center justify-between w-[100%] bg-yellow-400  border border-black rounded-lg hidden">
                                <button id="decQtyBtn<%= products[i]._id %><%= j %>" type="button" class="text-center flex justify-center w-full h-full bg-yellow-400 hover:bg-yellow-300 py-1 rounded-l-lg" onclick="decrementQuantity('<%= i %>','<%= j %>','<%= products[i]._id %>')">
                                    <i data-feather="minus"></i>
                                </button> 
                                <input type="text" id="quantity<%= products[i]._id %><%= j %>" value="1" class=" w-[5rem] bg-white px-2 text-xl  py-[0.22rem] border-black-x-sides text-center" >
                                <button id="incQtyBtn<%= products[i]._id %><%= j %>" type="button" class="text-center flex justify-center w-full h-full py-1 bg-yellow-400 hover:bg-yellow-300 rounded-r-lg" onclick="incrementQuantity('<%= i %>','<%= j %>','<%= products[i]._id %>')">
                                    <i data-feather="plus"></i>
                                </button>
                            </div>
                            <button type="button" id="addToCartBtn<%= products[i]._id %><%= j %>" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-2 rounded-md font-medium text-sm flex items-center justify-center" onclick="addToCartInitially(this,'<%- i %>','<%- j %>','<%- products[i]._id %>','<%- j %>')">
                                <i data-feather="shopping-cart" class="w-4 h-4 mr-2"></i> Add to Cart
                            </button>
                    <% } %>
                </div> 
                <% } %>
               <% } %>
            <% } %>
         <% } %>
      </div>
    </section>
  </div>

  <!-- Footer -->
  <%- include("../partials/user-side/footer.ejs")%>

  <%- include("../../public/javascript/user-javascript/shop-validation.ejs")%>