<%- include("../partials/user-side/navbar.ejs",{title : "Novamrt - Shop"})%>

  <!-- Main Container -->
  <div class="flex max-w-7xl mx-auto my-10 px-4 gap-8">
    
    <!-- Sidebar Filters -->
    <aside class="w-1/4 h-[50%] bg-white p-5 rounded-xl shadow-sm">
      <h2 class="text-lg font-semibold mb-4">Filters</h2>

      <form action="/shop/filter" method="POST" class="space-y-6">

        <!-- Category Filter -->
        <div>
          <h3 class="font-medium mb-2">Category</h3>
          <div class="space-y-1">
            <% for( let i = 0; i < categories.length; i++ ) { %>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="category" value="<%= categories[i]._id  %>" class="accent-emerald-600">
              <%= categories[i].categoryName %>
            </label>
            <% } %>
          </div>
        </div>

        <!-- Price Filter -->
        <div>
          <h3 class="font-medium mb-2">Price Range</h3>
          <div class="flex items-center gap-2">
            <label for="minPrice">Min</label>
            <input type="number" id="minPrice" name="minPrice" placeholder="0" class="border rounded-lg w-1/2 p-2">
            <label for="minPrice">Max</label>
            <input type="number" id="maxPrice" name="maxPrice" placeholder="100" class="border rounded-lg w-1/2 p-2">
          </div>
        </div>

        <!-- Brand Filter -->
        <div>
          <h3 class="font-medium mb-2">Brand</h3>
          <div class="space-y-1">
            <% for( let i = 0; i < brands.length; i++ ) { %>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="brand" value="<%= brands[i]._id %>" class="accent-emerald-600">
                <%= brands[i].brandName %>
              </label>
            <% } %>
          </div>
        </div>

        <!-- Apply Filter Button -->
        <button type="submit" class="filterButton w-full font-bold text-gray-700 py-2 px-4 rounded-lg transition duration-300 mb-4">
          Apply Filters
        </button>
      </form>
    </aside>

    <!-- Product Section -->
    <section class="flex-1">

      <!-- Sort Buttons -->
      <div class="flex flex-wrap items-center justify-between mb-6">
        <h2 class="text-xl font-semibold">All Products</h2>
        <div class="flex gap-2">
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="featured">Featured</button>
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="low-high">Price: Low → High</button>
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="high-low">Price: High → Low</button>
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="az">A → Z</button>
          <button class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md" data-sort="za">Z → A</button>
        </div>
      </div>

      <!-- Products Grid -->
      <div id="productGrid" class="flex flex-wrap gap-4">
        <% const now = new Date() %>
        <% let productCount = 0 %>
        <% for( let i = 0; i < products.length; i++ ) { %>
          <% if (!products[i].categoryId.isDeleted && !products[i].brandId.isDeleted) { %>
            <% if (!products[i].isDeleted) { %>
                <% for( let j = 0; j < products[i].variants.length; j++ ) { %>
                 <% productCount++ %>
              <% if ( products[i].variants[j].stockQuantity !== 0 && products[i].variants[j].stockStatus !== "Out of Stock" ) { %>
                <%
                /* ================================
                   Base values
                ================================ */
                const price = products[i].variants[j].price
                const productOffer = products[i].variants[j].productOfferId
                const categoryOffer = products[i].categoryOfferId
                
                let offerPrice = price
                let productOfferPrice = null
                let categoryOfferPrice = null
                
                /* ================================
                   Check offer activeness
                ================================ */
                const isProductOfferActive =
                  productOffer &&
                  productOffer.startDate <= now &&
                  productOffer.endDate >= now
                
                const isCategoryOfferActive =
                  categoryOffer &&
                  categoryOffer.startDate <= now &&
                  categoryOffer.endDate >= now
                
                /* ================================
                   Calculate product offer price
                ================================ */
                if (isProductOfferActive) {
                  if (productOffer.discountType === "percentage") {
                    productOfferPrice =
                      price - (price * productOffer.discountValue) / 100
                  } else if (productOffer.discountType === "flat") {
                    productOfferPrice =
                      price - productOffer.discountValue
                  }
                }
                
                /* ================================
                   Calculate category offer price
                ================================ */
                if (isCategoryOfferActive) {
                  if (categoryOffer.discountType === "percentage") {
                    const percentPrice =
                      price - (price * categoryOffer.discountValue) / 100
                
                    const maxPrice =
                      price - categoryOffer.maxDiscountAmount
                
                    // Apply max discount cap
                    categoryOfferPrice = Math.max(percentPrice, maxPrice)
                
                  } else if (categoryOffer.discountType === "flat") {
                    if (price > categoryOffer.productMinPrice) {
                      categoryOfferPrice =
                        price - categoryOffer.discountValue
                    }
                  }
                }
                
                /* ================================
                   Decide final offer price
                ================================ */
                if (productOfferPrice !== null && categoryOfferPrice !== null) {
                  // Both active → choose better discount
                  offerPrice = Math.min(productOfferPrice, categoryOfferPrice)
                
                } else if (productOfferPrice !== null) {
                  // Only product offer active
                  offerPrice = productOfferPrice
                
                } else if (categoryOfferPrice !== null) {
                  // Only category offer active
                  offerPrice = categoryOfferPrice
                }
                // Else → no active offer, original price remains
                %>
                  <div class="product-card bg-white rounded-lg shadow-sm p-4 transition-all w-[214px]">
                    <div class="h-40 mb-3 relative">
                        <img src="<%= products[i].variants[j].productImages[0] %>" alt="Product" class="w-full h-full object-contain">
                        <% let isProductInWishlist = wishlistItems.find(item => String(products[i]._id) === String(item.productId) && item.variant === j)%>
                        <button  type="button" class="absolute top-2 right-2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100" onclick="removeFromWishlist('<%= products[i]._id %>','<%= j %>')">
                            <i data-feather="heart" class="w-4 h-4" fill="#FF2400" stroke="#FF2400"></i>
                        </button>
                      
                            <button id="addWishBtn<%= products[i]._id %><%= j %>" type="button" class="absolute top-2 right-2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100 <%= (isProductInWishlist) ? 'hidden' : '' %>" onclick="addToWishlist(this,'<%= products[i]._id %>','<%= j %>')">
                                <i  data-feather="heart" class="w-4 h-4" ></i>
                            </button>
                        <a href="/product?id=<%= products[i]._id %>&variant=<%= j%>">
                            <button class="absolute top-12 right-2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100">
                                <i data-feather="eye" class="w-4 h-4"></i>
                            </button>
                        </a>
                    </div>
                    <h3 class="font-medium text-sm mb-1 truncate"><%= products[i].productName  %></h3>
                    <div class="flex items-center mb-1">
                        <div class="text-yellow-400 flex">
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                            <i data-feather="star" class="w-4 h-4 fill-current"></i>
                        </div>
                        <span class="text-gray-500 text-xs ml-1">(4,567)</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="font-regular text-xs">Brand : <a href="#" class="text-blue-700"><%= (products[i].brandId.brandName) %></a></span>
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="font-regular text-gray-700 text-xs">Size : <a href="#" ><%= (products[i].variants[j].size) %></a></span>
                    </div>
                    <div class="flex flex-shrink-0 justify-between items-center mb-2">
                      <% if (offerPrice > 0 && offerPrice < products[i].variants[j].price ) { %>
                        <span class="font-bold text-lg">$<span id="price<%= products[i]._id  %><%= j %>" ><%= offerPrice.toFixed(2) %></span>
                        <span class="text-gray-500 text-sm line-through ">$<%= (products[i].variants[j].price).toFixed(2)  %></span>
                        <span class="text-green-600 text-xs font-medium"><%= (((products[i].variants[j].price - offerPrice) / products[i].variants[j].price) * 100).toFixed(0) %>% off</span>   
                    <% } else {%>
                        <span class="font-bold text-lg">$<span id="price<%= products[i]._id  %><%= j %>" ><%= (products[i].variants[j].price).toFixed(2) %></span>
                    <% } %>
                    </div>
                     <% let isProductInCart = cartItems.find(item =>  String(products[i]._id) === String(item.productId._id) && item.variant === j ) || null %>
                        <% if (isProductInCart) { %>
                            <div class="flex  justify-between ">
                            <button type="button" id="addToCartBtn<%= products[i]._id %><%= j %>" class="w-[0%] bg-yellow-400 hover:bg-yellow-500 text-gray-900  rounded-md font-medium text-sm flex items-center justify-center" onclick="addToCartInitially(this,'<%- i %>','<%- j %>','<%- products[i]._id %>','<%- j %>')">
                                <i data-feather="shopping-cart" class="w-4 h-4 mr-2"></i> 
                            </button>
                                <div id="incDecQtyDiv<%= products[i]._id %><%= j %>" class="flex items-center justify-between w-[100%]  rounded-lg   border border-black w-full ">
                                    <button id="decQtyBtn<%= products[i]._id %><%= j %>" type="button" class="text-center flex justify-center w-full h-full bg-yellow-400 hover:bg-yellow-300 py-1 rounded-l-lg"  onclick="decrementQuantity('<%= i %>','<%= j %>','<%= products[i]._id %>')">
                                        <i data-feather="minus"></i>
                                    </button> 
                                    <input type="text" id="quantity<%= products[i]._id %><%= j %>" value="<%= isProductInCart.quantity %>" class=" w-[5rem] px-2 text-xl bg-white font-bold py-[0.22rem] border-black-x-sides text-center" >
                                    <button id="incQtyBtn<%= products[i]._id %><%= j %>" type="button" class="text-center flex justify-center w-full h-full py-1 bg-yellow-400 hover:bg-yellow-300 rounded-r-lg"  onclick="incrementQuantity('<%= i %>','<%= j %>','<%= products[i]._id %>')">
                                        <i data-feather="plus"></i>
                                    </button>
                                </div>
                            </div>
                    <% } else {%>
                        <!-- <a  href="/home/cart?productId=&variant=&quantity=1"> -->
                            <div id="incDecQtyDiv<%= products[i]._id %><%= j %>" class="flex items-center justify-between w-[100%] bg-yellow-400  border border-black rounded-lg hidden">
                                <button id="decQtyBtn<%= products[i]._id %><%= j %>" type="button" class="text-center flex justify-center w-full h-full bg-yellow-400 hover:bg-yellow-300 py-1 rounded-l-lg" onclick="decrementQuantity('<%= i %>','<%= j %>','<%= products[i]._id %>')">
                                    <i data-feather="minus"></i>
                                </button> 
                                <input type="text" id="quantity<%= products[i]._id %><%= j %>" value="1" class=" w-[5rem] bg-white px-2 text-xl  py-[0.22rem] border-black-x-sides text-center" >
                                <button id="incQtyBtn<%= products[i]._id %><%= j %>" type="button" class="text-center flex justify-center w-full h-full py-1 bg-yellow-400 hover:bg-yellow-300 rounded-r-lg" onclick="incrementQuantity('<%= i %>','<%= j %>','<%= products[i]._id %>')">
                                    <i data-feather="plus"></i>
                                </button>
                            </div>
                            <button type="button" id="addToCartBtn<%= products[i]._id %><%= j %>" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-2 rounded-md font-medium text-sm flex items-center justify-center" onclick="addToCartInitially(this,'<%- i %>','<%- j %>','<%- products[i]._id %>','<%- j %>')">
                                <i data-feather="shopping-cart" class="w-4 h-4 mr-2"></i> Add to Cart
                            </button>
                    <% } %>
                </div> 
                  <% } %>
                <% } %>
               <% } %>
            <% } %>
         <% } %>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-sm text-gray-500">
          Showing <span class="font-medium">1</span> to <span class="font-medium"><%= productCount %></span> of <span class="font-medium"><%= count %></span> results
        </div>
        <div class="flex space-x-2">
          
          <a href="/shop?page=<%= Number(page) > 1 ? Number(page) - 1 : 1 %>">
            <% if (Number(page) === 1) { %>
              <button class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" disabled>
                Previous
              </button>
            <% } else {%>
              <button class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" >
                Previous
              </button>
              <% } %>
          
         </a>
          <% let i = Number(page) > 4 ? Number(page) - 3 : 1 %>
          <% for(;i <= pages; i++ ) { %>
          <a href="/shop?page=<%= i %>">
            <button class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700">
              <%= i %>
            </button>
          </a>
          <% } %>
          <a href="/shop?page=<%= Number(page) < pages ? Number(page) + 1 : pages %>">
            <% if (Number(page) === pages) { %>
              <button class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" disabled>
                Next
              </button>
            <% } else {%>
              <button class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" >
                Next
              </button>
              <% } %>
          
         </a>
        </div>
      </div>
    </section>
    
  </div>

  <script>
    function addToWishlist(btn,productId,variant){
        btn.classList.add("hidden")
        let itemCount = document.getElementById("wishlistItemQty")
        fetch(`/wishlist?productId=${productId}&variant=${variant}`,{method : "POST"})
        .then(res => res.json())
        .then(data => {
            iziToast.success({
                title : "Wishlist",
                message : data.message,
                position : "topRight"
            })
        })
        .catch(error => {
            iziToast.error({
                title : "Wishlist",
                message : error.message,
                position : "topRight"
            })
        })
        if(Number(itemCount.innerText) === 0){
            itemCount.classList.remove("hidden")
             let value = Number(itemCount.innerText)
             value++
             itemCount.innerText = value

        }else if(Number(itemCount.innerText) > 0){
            let value = Number(itemCount.innerText)
            value++
            itemCount.innerText = value
        }
    }
    function removeFromWishlist(productId,variant){
        document.getElementById(`addWishBtn${productId}${variant}`).classList.remove("hidden")
        let itemCount = document.getElementById("wishlistItemQty")
        fetch(`/wishlist/remove-wishlist-item?productId=${productId}&variant=${variant}`,{method : "DELETE"})
        .then(res => res.json())
        .then(data => {
            iziToast.success({
                title : "Wishlist",
                message : data.message,
                position : "topRight"
            })
        })
        .catch(error => {
            iziToast.error({
                title : "Wishlist",
                message : error.message,
                position : "topRight"
            })
        })
         if(Number(itemCount.innerText) > 0){
            let value = Number(itemCount.innerText)
            value--
            itemCount.innerText = value
            if(value === 0){
                itemCount.classList.add("hidden")
            }
        }
    }
</script>
  <!-- Footer -->
  <%- include("../partials/user-side/footer.ejs")%>

  <%- include("../../public/javascript/user-javascript/shop-validation.ejs")%>