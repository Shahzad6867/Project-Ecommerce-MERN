<%- include("../partials/user-side/navbar.ejs",{title : "Novamart - My Wallet"})%>
<div class="flex">
    <%- include("../partials/user-side/userProfile-sidebar.ejs",{dashboardBtn : "",profileBtn : "",ordersBtn : "",shoppingCartBtn : "",addressBtn : "",walletBtn : "active disabled"})%>
    <div class="main-content">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">My Wallet</h1>
            <button type="button" onclick="document.getElementById('addMoneyModal').classList.remove('hidden')" 
                    class="px-3 py-2 bg-green-500  text-black transition duration-300 rounded-md hover:bg-green-400 flex items-center">
                <i data-feather="plus" class="w-4 h-4 mr-2"></i>
                Add Money
            </button>
        </div>

        <div class=" gap-6 mb-8">
            <div class="wallet-card wallet-balance p-6 lg:col-span-1">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Wallet Balance</h2>
                    <i data-feather="credit-card" class="w-6 h-6"></i>
                </div>
                <div class="text-3xl font-bold mb-2">$ <%= wallet[0].walletBalance.toFixed(2) %></div>
                <p class="text-sm ">Available for instant checkout</p>
            </div>

            
        </div>

        <div class="wallet-card p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Transactions</h2>
                <a href="#" class="text-blue-600 hover:underline"></a>
            </div>

            <div class="divide-y divide-gray-200">
                <% if (wallet[0].transactions.length === 0) { %>
                    <div class="transaction-item">
                        <div class="text-center border rounded-md py-3 bg-gray-100">
                           <h1 class="font-bold text-xl">No wallet activity yet</h1>
                           <p>Top up your wallet or place an order to see transactions here.</p>
                        </div>
                    </div>
                <% } %>

                <% if (!Array.isArray(wallet[0].transactions)) { %>
                    <% for( let i = wallet.length - 1; i >= 0 ; i-- ) { %>
                        <% if (wallet[i].transactions.transactionReason === "Wallet Top-up") { %>
                            <div class="transaction-item py-4">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center px-2">
                                        <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                                            <i data-feather="dollar-sign" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-medium">Wallet Top-up</h3>
                                            <p class="text-sm text-gray-500"> <%= new Date(wallet[i].transactions.createdAt).toLocaleDateString("en-IN", {
                                                day: "numeric",
                                                month: "short",
                                                year: "numeric"
                                            }) %> • <%= new Date(wallet[i].transactions.createdAt).toLocaleTimeString('en-US', { 
                                                    hour: '2-digit', 
                                                    minute: '2-digit', 
                                                    hour12: true 
                                                }) %></p>
                                        </div>
                                    </div>
                                    <div >
                                        <p class="font-bold px-4 flex justify-center items-center rounded-full bg-green-400">$<%= wallet[i].transactions.transactionAmount.toFixed(2) %></p>
                                        <p class="text-sm text-gray-500 text-center">Credit Card</p>
                                    </div>
                                </div>
                            </div>
                        <% } else if(wallet[i].transactions.transactionReason === "Novamart Purchase"){ %>
                            <div class="transaction-item py-4">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center px-2">
                                        <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                                            <i data-feather="shopping-bag" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-medium">Order <%= wallet[i].transactions.paymentId.orderId.orderId %></h3>
                                            <p class="text-sm text-gray-500"><%= new Date(wallet[i].transactions.createdAt).toLocaleDateString("en-IN", {
                                                day: "numeric",
                                                month: "short",
                                                year: "numeric"
                                            }) %> • <%= new Date(wallet[i].transactions.createdAt).toLocaleTimeString('en-US', { 
                                                    hour: '2-digit', 
                                                    minute: '2-digit', 
                                                    hour12: true 
                                                }) %></p>
                                        </div>
                                    </div>
                                    <div >
                                        <p class="font-bold px-4 flex justify-center items-center rounded-full bg-red-400">$<%= wallet[i].transactions.transactionAmount.toFixed(2) %></p>
                                        <p class="text-sm text-gray-500 text-center">Purchase</p>
                                    </div>
                                </div>
                            </div>
    
                        
                        <% } else if (wallet[i].transactions.transactionReason === "Order Refund") { %>
                            <div class="transaction-item py-4">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center px-2">
                                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                                            <i data-feather="rotate-ccw" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-medium">Order <%= wallet[i].transactions.paymentId.orderId.orderId %></h3>
                                            <p class="text-sm text-gray-500"><%= new Date(wallet[i].transactions.createdAt).toLocaleDateString("en-IN", {
                                                day: "numeric",
                                                month: "short",
                                                year: "numeric"
                                            }) %> • <%= new Date(wallet[i].transactions.createdAt).toLocaleTimeString('en-US', { 
                                                    hour: '2-digit', 
                                                    minute: '2-digit', 
                                                    hour12: true 
                                                }) %></p>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="font-bold px-4 flex justify-center items-center rounded-full bg-green-400">$<%= wallet[i].transactions.transactionAmount.toFixed(2) %></p>
                                        <p class="text-sm text-gray-500 text-center">Order Refund</p>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                    <% } %>
                        

                       
                <% } %>
            </div>
        </div>

        
    </div>

    <!-- Add Money Modal -->
    <div id="addMoneyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Add Money to Wallet</h2>
                <button onclick="document.getElementById('addMoneyModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <form class="space-y-4" action="/wallet/top-up" method="post" id="addMoneyForm" onsubmit="return validateAddmoneyForm()" novalidate>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500">$</span>
                        <input id="amount" type="number" name="amount" step="0.01" min="1" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="0.00" >
                    </div>
                </div>
                
               
                
                <div class="pt-4">
                    <button type="submit" class="w-full py-3 px-4  font-semibold rounded-md transition duration-300 bg-green-500  text-black rounded-md hover:bg-green-400 flex items-center justify-center">
                        Add Money
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>
<script>
    function validateAddmoneyForm(){
        let amount = document.getElementById("amount")
        if(amount.value <= 0){
            iziToast.error({
                title : "Wallet",
                message : "Amount should be greater than 0",
                position : "topCenter"
            })
            return false
        }
        if(amount.value < 10){
            iziToast.error({
                title : "Wallet",
                message : "The minimum wallet top-up amount is $10",
                position : "topCenter"
            })
            return false
        }
        if(amount.value > 2000){
            iziToast.error({
                title : "Wallet",
                message : "The maximum allowed top-up amount is $250",
                position : "topCenter"
            })
            return false
        }

    }
</script>
<%- include("../partials/user-side/footer.ejs")%>